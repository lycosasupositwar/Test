<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Analysis Report</title>
    <style>
        @page {
            size: A4;
            margin: 1.5cm;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            font-size: 10pt;
        }
        h1, h2 {
            color: #333;
            border-bottom: 2px solid #f2f2f2;
            padding-bottom: 5px;
        }
        h1 { font-size: 24pt; }
        h2 { font-size: 16pt; }
        .summary-table, .measurements-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        .summary-table td, .measurements-table th, .measurements-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        .summary-table td:first-child {
            font-weight: bold;
            width: 30%;
            background-color: #f9f9f9;
        }
        .measurements-table th {
            background-color: #f2f2f2;
            font-weight: bold;
        }
        .images {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            page-break-inside: avoid;
        }
        .images .img-container {
            flex: 1;
            text-align: center;
        }
        .images img {
            max-width: 100%;
            max-height: 300px;
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
    <h1>Analysis Report: {{ sample.name }}</h1>
    <p><strong>Project:</strong> {{ project_name }}</p>
    <p><strong>Report Date:</strong> {{ date }}</p>

    <h2>Summary</h2>
    <table class="summary-table">
        {% if sample.results.astm_g %}
        <tr>
            <td>ASTM Grain Size (G)</td>
            <td>{{ "%.2f"|format(sample.results.astm_g) }}</td>
        </tr>
        {% endif %}
        {% if sample.results.multiphase %}
        <tr>
            <td>Phase 1 (White) %</td>
            <td>{{ "%.2f"|format(sample.results.multiphase.phase_1_percent) }}</td>
        </tr>
        <tr>
            <td>Phase 2 (Black) %</td>
            <td>{{ "%.2f"|format(sample.results.multiphase.phase_2_percent) }}</td>
        </tr>
        {% endif %}
        <tr>
            <td>Total Grains Found</td>
            <td>{{ sample.results.measurements|length if sample.results.measurements else 0 }}</td>
        </tr>
    </table>

    <h2>Images</h2>
    <div class="images">
        <div class="img-container">
            <h3>Original Image</h3>
            <img src="{{ original_image_b64 }}" alt="Original Image">
        </div>
        <div class="img-container">
            <h3>Segmented Image</h3>
            <img src="{{ segmented_image_b64 }}" alt="Segmented Image">
        </div>
    </div>

    {% if sample.results.measurements %}
    <h2>Grain Measurements</h2>
    <table class="measurements-table">
        <thead>
            <tr>
                <th>Grain ID</th>
                <th>Area (mm²)</th>
                <th>Perimeter (mm)</th>
                <th>Equiv. Ø (mm)</th>
                <th>Orientation (°)</th>
            </tr>
        </thead>
        <tbody>
            {% for grain in sample.results.measurements %}
            <tr>
                <td>{{ grain.grain_id }}</td>
                <td>{{ "%.4f"|format(grain.area_mm2) }}</td>
                <td>{{ "%.4f"|format(grain.perimeter_mm) }}</td>
                <td>{{ "%.4f"|format(grain.equiv_diameter_mm) }}</td>
                <td>{{ "%.2f"|format(grain.orientation_deg) }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% endif %}
</body>
</html>
